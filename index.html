<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cofit 直播抽獎</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",sans-serif;
  background:#0e1621;
  color:white;
  text-align:center;
}

h1{
  margin:20px 0 10px 0;
}

textarea{
  width:90%;
  height:220px;
  border-radius:12px;
  padding:10px;
  margin-bottom:10px;
}

button{
  padding:10px 18px;
  border-radius:10px;
  border:none;
  margin:5px;
  cursor:pointer;
  font-weight:bold;
}

.primary{
  background:#1fb8ad;
  color:#05201c;
}

.secondary{
  background:#222;
  color:white;
}

#winnerBox{
  font-size:36px;
  margin-top:20px;
  min-height:60px;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:1000;
}

.closeBtn{
  position:absolute;
  top:20px;
  right:30px;
  font-size:28px;
  cursor:pointer;
}

.confetti{
  position:fixed;
  width:8px;
  height:8px;
  background:gold;
  top:0;
  z-index:999;
}
</style>
</head>

<body>

<h1>Cofit 直播抽獎</h1>

<textarea id="chatInput" placeholder="貼上 Meet 聊天紀錄"></textarea><br>

抽幾位：
<select id="drawCount">
<option value="1">1</option>
<option value="2" selected>2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select>

<br>

<button class="secondary" onclick="parseNames()">整理名單</button>
<button class="primary" onclick="startDraw()">開始抽獎</button>

<div id="countInfo"></div>

<div class="modal" id="resultModal">
<div class="closeBtn" onclick="closeModal()">✕</div>
<div id="winnerBox"></div>
</div>

<script>
let names=[];
let drawing=false;

function parseNames(){
  const text=document.getElementById("chatInput").value;
  const lines=text.split("\n").map(l=>l.trim()).filter(l=>l!="");

  const unique=new Set();
  for(let i=0;i<lines.length;i++){
    const line=lines[i];
    const next=lines[i+1];

    // 判斷是否為時間行
    if(/(上午|下午|晚上)?\d{1,2}:\d{2}/.test(next)){
      unique.add(line);
    }
  }

  names=[...unique];
  document.getElementById("countInfo").innerText="名單人數："+names.length;
}

async function startDraw(){
  if(drawing) return;
  if(names.length===0){
    alert("請先整理名單");
    return;
  }

  drawing=true;
  const count=parseInt(document.getElementById("drawCount").value);
  const winners=[];
  const pool=[...names];

  for(let i=0;i<count;i++){
    if(pool.length===0) break;
    const index=Math.floor(Math.random()*pool.length);
    winners.push(pool[index]);
    pool.splice(index,1);
  }

  // 移除已中獎者
  names=names.filter(n=>!winners.includes(n));

  await showWinners(winners);
  drawing=false;
}

async function showWinners(winners){
  const modal=document.getElementById("resultModal");
  const box=document.getElementById("winnerBox");
  modal.style.display="flex";

  for(let i=0;i<winners.length;i++){
    box.innerText="抽獎中...";
    await sleep(800);

    box.innerText=winners[i];
    confettiEffect();
    await sleep(1500);
  }
}

function closeModal(){
  document.getElementById("resultModal").style.display="none";
}

function sleep(ms){
  return new Promise(resolve=>setTimeout(resolve,ms));
}

function confettiEffect(){
  for(let i=0;i<80;i++){
    const div=document.createElement("div");
    div.className="confetti";
    div.style.left=Math.random()*window.innerWidth+"px";
    div.style.background=`hsl(${Math.random()*360},100%,60%)`;
    div.style.animation=`fall 1.5s linear`;
    document.body.appendChild(div);
    setTimeout(()=>div.remove(),1500);
  }
}

const style=document.createElement('style');
style.innerHTML=`
@keyframes fall{
  from{transform:translateY(0)}
  to{transform:translateY(100vh)}
}
`;
document.head.appendChild(style);

</script>

</body>
</html>

